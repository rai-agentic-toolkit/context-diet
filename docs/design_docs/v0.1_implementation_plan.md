# V0.2 Architecture Refactoring Plan

The objective of this phase is to eliminate inherent flaws in the V0.1 implementation and elevate `context-diet` to a production-grade library capable of structural guarantees.

## Proposed Changes

### 1. Safe Structural Fallbacks
#### [MODIFY] src/context_diet/interfaces.py
- Define `ContextBudgetExceededError` custom exception.
#### [MODIFY] src/context_diet/strategies/json_diet.py
#### [MODIFY] src/context_diet/strategies/python_ast.py
#### [MODIFY] src/context_diet/strategies/sql_diet.py
#### [MODIFY] src/context_diet/strategies/yaml_diet.py
- Remove the `PlainTextDietStrategy` fallback step from all structural parsers.
- Return valid minimal representations (e.g., `{}`, `[]`, minimal class/func) or raise `ContextBudgetExceededError` if the absolute minimum valid structural payload still exceeds the target budget.

### 2. Dependency Inclusion & Safe Lexical Parsing
#### [MODIFY] pyproject.toml
- Add dependencies: `sqlparse`, `ruamel.yaml`, `libcst`
#### [MODIFY] src/context_diet/strategies/sql_diet.py
- Replace regex scrubbing with `sqlparse.format(content, strip_comments=True)`.
#### [MODIFY] src/context_diet/strategies/yaml_diet.py
- Replace regex scrubbing with `ruamel.yaml` round-trip parsing to safely strip comments without corrupting embedded strings.

### 3. Non-Destructive Python Parsing
#### [MODIFY] src/context_diet/strategies/python_ast.py
- Refactor `DocScrubber` and `Skeletonizer` to use `libcst` (Concrete Syntax Tree) instead of the standard library `ast`. This will guarantee preservation of `#` inline comments, blank lines, and existing format formatting alongside specific structural removal.

### 4. Strict Tokenizer Contract Warning
#### [MODIFY] src/context_diet/distiller.py
- Import the python `warnings` module. If `default_token_heuristic` is utilized, issue a loud `RuntimeWarning` emphasizing that accurate token budgeting requires a genuine tokenizer (like `tiktoken`).

### 5. Documentation Archival
- Copy existing agent artifacts (`task.md`, `implementation_plan.md`, `walkthrough.md`) into `docs/design_docs/` in the repository for historical record.

## Verification Plan
### Automated Tests
- `pytest tests/`: Assure the existing 17 tests all pass or are updated to handle the new behaviors.
- Write explicit edge cases for SQL literals with comment markers inside.
- Write tests to ensure Python inline comments remain intact.
- Verify that impossible budgets throw `ContextBudgetExceededError` cleanly across all strategies.
